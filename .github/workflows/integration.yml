name: Integration - DB + Dev + API POST

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  integration:
    runs-on: ubuntu-latest
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - "8123:8123"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd app
          npm ci

      - name: Start Next dev server
        run: |
          cd app
          nohup npm run dev &
          # wait for the server to be available on port 3000
          for i in $(seq 1 60); do
            if curl -sSf "http://127.0.0.1:3000/" > /dev/null 2>&1; then
              echo "server up"
              break
            fi
            echo "waiting... $i"
            sleep 1
          done

      - name: POST match and assert 200
        run: |
          set -e
          cat > payload.json <<'EOF'
{
  "map_id": null,
  "map_name": "Corrupted Isle",
  "flux": "Like a Boss (2013, until September 26th)",
  "day": 29,
  "month": 9,
  "year": 2012,
  "occasion": "Playoffs",
  "match_duration": "0:00",
  "match_original_duration": "0:00",
  "match_end_time_ms": 0,
  "match_end_time_formatted": "0:00.000",
  "winner_party_id": 2,
  "parties": {
    "1": {
      "PLAYER": [
        { "id": 1001, "primary": 1, "secondary": 8, "level": 20, "team_id": 1, "player_number": 1, "guild_id": 1, "model_id": 0, "gadget_id": 0, "encoded_name": "Fossil Fuels", "skill_template_code": "", "used_skills": [1697,352,331,332,326,1404,1414,1481] }
      ],
      "OTHER": []
    },
    "2": { "PLAYER": [], "OTHER": [] }
  },
  "guilds": { "1": { "id": 1, "name": "Zero Quality", "tag": "zQ", "rank": 1 }, "2": { "id": 2, "name": "The Last Captain", "tag": "LaG", "rank": 2 } },
  "credits": "Guild Wars Memorial",
  "added_to_website": "25 Apr 2015 02:38:19 CEST",
  "description": null,
  "vod_urls": []
}
EOF

          http_status=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST http://127.0.0.1:3000/api/matchs \
            -H "Content-Type: application/json" \
            -d @payload.json || true)
          echo "HTTP status: $http_status"
          if [ "$http_status" != "200" ]; then
            echo "Expected 200 but got $http_status"
            exit 1
          fi

