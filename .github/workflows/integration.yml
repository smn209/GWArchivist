name: Integration - Dev + API POST (simple)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start ClickHouse via docker compose
        run: |
          docker compose -f database/docker-compose.yml up -d
          # wait for ClickHouse HTTP port
          echo "Waiting for ClickHouse to start..."
          for i in $(seq 1 60); do
            if curl -sSf "http://127.0.0.1:8123/" > /dev/null 2>&1; then
              echo "ClickHouse is up!"
              break
            fi
            echo "waiting for clickhouse... $i"
            sleep 2
          done
          
      - name: Initialize database schema
        run: |
          echo "Loading database schema..."
          
          # Create database first
          echo "Creating database..."
          curl -X POST "http://127.0.0.1:8123/" \
            --user "dev:dev" \
            -d "CREATE DATABASE IF NOT EXISTS gwarchivist"
          
          # execute schema ctp/pipe
          echo "Loading tables..."
          cat database/schema.sql | docker exec -i gwgvg_clickhouse clickhouse-client \
            --user=dev --password=dev --database=gwarchivist \
            --multiquery
          
          # Verify database and tables exist
          echo "=== Verifying databases ==="
          curl -sSf "http://127.0.0.1:8123/" --user "dev:dev" -d "SHOW DATABASES"
          
          echo "=== Verifying tables in gwarchivist ==="
          tables=$(curl -sSf "http://127.0.0.1:8123/" --user "dev:dev" -d "SHOW TABLES FROM gwarchivist")
          echo "$tables"
          
          if echo "$tables" | grep -q "pseudos"; then
            echo "Schema loaded successfully!"
          else
            echo "Schema loading failed - pseudos table not found"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd app
          npm ci

      - name: Start Next dev server
        run: |
          cd app
          # Start the dev server in background
          nohup npm run dev > dev-server.log 2>&1 &
          # Wait for server to be ready
          echo "Waiting for Next.js dev server to start..."
          for i in $(seq 1 60); do
            if curl -sSf "http://127.0.0.1:3000/api/health" > /dev/null 2>&1; then
              echo "Next.js dev server is ready"
              break
            elif curl -sSf "http://127.0.0.1:3000/" > /dev/null 2>&1; then
              echo "Next.js dev server is ready (health endpoint not available)"
              break
            fi
            echo "waiting for dev server... $i"
            sleep 2
          done
          # Show server logs for debugging
          echo "=== Dev server logs ==="
          tail -20 dev-server.log || echo "No logs available"

      - name: POST match and assert 200
        run: |
          set -e
          cd app
          # Set environment variables for ClickHouse connection
          export CLICKHOUSE_URL="http://127.0.0.1:8123"
          export CLICKHOUSE_USER="dev" 
          export CLICKHOUSE_PASSWORD="dev"
          
          # POST the provided full match.json file
          echo "Sending POST request to /api/matchs..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST http://127.0.0.1:3000/api/matchs \
            -H "Content-Type: application/json" \
            -d @../.github/workflows/match.json)
          
          # Extract HTTP status and response body
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          response_body=$(echo "$response" | grep -v "HTTP_STATUS:")
          
          echo "Response body: $response_body"
          echo "HTTP status: $http_status"
          
          if [ "$http_status" != "200" ]; then
            echo "Expected 200 but got $http_status"
            echo "=== Dev server logs ==="
            tail -50 dev-server.log || echo "No logs available"
            exit 1
          else
            echo "SUCCESS: Match posted successfully!"
          fi

