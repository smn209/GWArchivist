name: Integration - DB + Dev + API POST

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  integration:
    runs-on: ubuntu-latest
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:latest
        ports:
          - 8123:8123
        options: >-
          --health-cmd="curl -fsS http://localhost:8123/ || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd app
          npm ci

      - name: Start Next dev server
        run: |
          cd app
          nohup npm run dev &
          # wait for the server to be available on port 3000
          for i in {1..30}; do
            if curl -sSf "http://127.0.0.1:3000/" > /dev/null; then
              echo "server up"
              break
            fi
            echo "waiting... $i"
            sleep 1
          done

      - name: POST match and assert 200
        run: |
          set -e
          cat > payload.json <<'JSON'
{"map_id":null,"map_name":"Corrupted Isle","flux":"Like a Boss (2013, until September 26th)","day":29,"month":9,"year":2012,"occasion":"Playoffs","match_duration":"0:00","match_original_duration":"0:00","match_end_time_ms":0,"match_end_time_formatted":"0:00.000","winner_party_id":2,"parties":{"1":{"PLAYER":[{"id":1001,"primary":1,"secondary":8,"level":20,"team_id":1,"player_number":1,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Fossil Fuels","skill_template_code":"","used_skills":[1697,352,331,332,326,1404,1414,1481]},{"id":1002,"primary":5,"secondary":1,"level":20,"team_id":1,"player_number":2,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Motoko Kai Il","skill_template_code":"","used_skills":[1412,28,1335,50,61,23,1,349]},{"id":1003,"primary":6,"secondary":1,"level":20,"team_id":1,"player_number":3,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Orange Caramel","skill_template_code":"","used_skills":[1098,1382,213,2192,1999,235,208,2]},{"id":1004,"primary":6,"secondary":8,"level":20,"team_id":1,"player_number":4,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Jorns On Fire","skill_template_code":"","used_skills":[1373,219,1374,171,176,200,169,2]},{"id":1005,"primary":6,"secondary":3,"level":20,"team_id":1,"player_number":5,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"The Kings Dead","skill_template_code":"","used_skills":[1662,191,189,187,180,184,1381,288]},{"id":1006,"primary":3,"secondary":1,"level":20,"team_id":1,"player_number":6,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Farewell Jaisalmer","skill_template_code":"","used_skills":[276,307,1114,2063,299,258,309,371]},{"id":1007,"primary":3,"secondary":7,"level":20,"team_id":1,"player_number":7,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"Marley Extended","skill_template_code":"","used_skills":[282,2061,292,311,887,258,2003,1037]},{"id":1008,"primary":8,"secondary":6,"level":20,"team_id":1,"player_number":8,"guild_id":1,"model_id":0,"gadget_id":0,"encoded_name":"C H A M A L E E","skill_template_code":"","used_skills":[843,793,787,1265,1219,0,981,200]}],"OTHER":[]},"2":{"PLAYER":[{"id":2001,"primary":1,"secondary":8,"level":20,"team_id":2,"player_number":1,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Red Wine Snizl","skill_template_code":"","used_skills":[355,352,331,332,1404,2196,316,0]},{"id":2002,"primary":7,"secondary":6,"level":20,"team_id":2,"player_number":2,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Braindead Dome","skill_template_code":"","used_skills":[1644,1023,780,777,1990,776,207,1043]},{"id":2003,"primary":6,"secondary":3,"level":20,"team_id":2,"player_number":3,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Bloodred Untouched","skill_template_code":"","used_skills":[1662,191,189,187,180,184,1381,288]},{"id":2004,"primary":6,"secondary":1,"level":20,"team_id":2,"player_number":4,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Saints Seppuku","skill_template_code":"","used_skills":[1373,219,171,173,176,200,169,0]},{"id":2005,"primary":6,"secondary":8,"level":20,"team_id":2,"player_number":5,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Ill Toreno Ill","skill_template_code":"","used_skills":[1098,1382,213,2192,1999,235,200,0]},{"id":2006,"primary":3,"secondary":1,"level":20,"team_id":2,"player_number":6,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Male Monk Menik","skill_template_code":"","used_skills":[276,257,1114,2063,299,258,309,371]},{"id":2007,"primary":3,"secondary":7,"level":20,"team_id":2,"player_number":7,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Infinity Math","skill_template_code":"","used_skills":[282,2061,292,311,887,258,2003,1037]},{"id":2008,"primary":3,"secondary":1,"level":20,"team_id":2,"player_number":8,"guild_id":2,"model_id":0,"gadget_id":0,"encoded_name":"Pfefferkuchen No Go","skill_template_code":"","used_skills":[282,2061,299,1401,258,2003,349,371]}],"OTHER":[]}},"guilds":{"1":{"id":1,"name":"Zero Quality","tag":"zQ","rank":1,"features":0,"rating":0,"faction":0,"faction_points":0,"qualifier_points":0,"cape":{},"country":"A"},"2":{"id":2,"name":"The Last Captain","tag":"LaG","rank":2,"features":0,"rating":0,"faction":0,"faction_points":0,"qualifier_points":0,"cape":{},"country":"E"}},"credits":"Guild Wars Memorial","added_to_website":"25 Apr 2015 02:38:19 CEST","description":null,"vod_urls":[]}
JSON

          # perform POST and expect 200
          http_status=$(curl -s -o /dev/stderr -w "%{http_code}" -X POST http://127.0.0.1:3000/api/matchs \
            -H "Content-Type: application/json" \
            -d @payload.json || true)
          echo "HTTP status: $http_status"
          if [ "$http_status" != "200" ]; then
            echo "Expected 200 but got $http_status"
            exit 1
          fi

